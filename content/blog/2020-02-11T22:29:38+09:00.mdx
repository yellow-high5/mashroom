---
date: 2020-02-11T22:29:38+09:00
title: ログイン認証のしくみとつくり
thumbnail: 'https://res.cloudinary.com/dso4npatn/image/upload/v1646834505/media/blog/thumbnail/%E3%83%AD%E3%82%AF%E3%82%99%E3%82%A4%E3%83%B3%E8%AA%8D%E8%A8%BC%E3%81%AE%E3%81%97%E3%81%8F%E3%81%BF%E3%81%A8%E3%81%A4%E3%81%8F%E3%82%8A_zpwolw.png'
tag:
  - サーバーサイド
---

Firebase を使った時も勉強したのに、ちゃんと記録に残さないからまた勉強することになりました。  
今度はちゃんと記録に残して、認証システムの理解を深めていこうと思います。  
この記事は他の記事を参考にまとめた、全体像を掴むのに適した記事です。

## 前提知識

認証の仕組みを理解する上で切り離すことのできない用語類は以下のようにまとめてみました。以下の記事を読むとそれなりに API ファーストの認証方法やセキュリティについて理解できるようになるかと思います。

> - [この Web API って CSRF 対策出来てますか？って質問にこたえよう - Qiita](https://qiita.com/maruloop/items/e14d02299bd136f4b1fc)
> - [【REST API】認証トークンをどのように扱うのが良さげか調べたことをまとめる - s u p ?](https://whatsupguys.net/programming-learning-142/)
> - [SPA の CSRF 対策や CORS について検証する - 30 歳からのプログラミング](https://numb86-tech.hatenablog.com/entry/2019/02/13/221458)
> - [Cookie と WebStorage と Session についてのまとめ - Qiita](https://qiita.com/pipiox/items/95554673ba3b078ac112)

- 認証(Authentication)...ユーザー識別。通信相手が誰かを確認すること。

- 認可(Authorization)...ユーザー権限付与。特定の条件に対してリソースアクセスの権限を与えること。

- セッション...ある一連の処理の流れをステートレスなプロトコルである HTTP 通信の中で達成するための仕組み

- 暗号化...もとに戻す事を前提とした変換。

- ハッシュ化...もとに戻せない一方通行の不可逆変換。

- Salt(ソルト)...パスワードやパスフレーズなどのデータをハッシュ化する際に、一方向性関数の入力に加えるランダムなデータのこと。

- CSRF：Cross-site Request Forgery(リクエスト強要)...オンラインサービスを利用するユーザーがログイン状態を保持したまま悪意のある第三者の作成した URL などをクリックした場合などに、本人が意図しない形で情報・リクエストを送信されてしまうこと。

- XSS：Cross-site Scripting(スクリプトインジェクション)...クライアント側にスクリプトを実行させてページの書き換えやセッションハイジャックなどの認証情報を奪う攻撃。入力フォームや URL パラメータに脆弱性が生まれやすい。モダンなフロントフレームワークでは XSS 対策されているものもある。

- [Same-Origin Policy(同一生成元ポリシー)](https://developer.mozilla.org/ja/docs/Web/Security/Same-origin_policy)...あるオリジンから読み込まれた文書やスクリプトについて、そのリソースから他のオリジンのリソースにアクセスできないように制限する。つまり、異なるオリジンに対し，HTTP リクエストは送ることはできるが，その結果の読み取りはできない。

- [CORS(クロスオリジン HTTP リクエスト)](https://developer.mozilla.org/ja/docs/Web/HTTP/CORS)...追加の HTTP ヘッダーを使用して、あるオリジンで動作しているウェブアプリケーションに、異なるオリジンにある選択されたリソースへのアクセス権を与えるようブラウザーに指示するための仕組み。

- [Preflight リクエスト](https://developer.mozilla.org/ja/docs/Glossary/Preflight_request)...クロスオリジンのリクエスト先に，事前にリクエストしていいかの確認を行う(CORS 確認を行う)ために飛ばされるリクエスト。これだけで CSRF 対策ができるのでは？とされており、その場合[カスタムヘッダ](https://developer.mozilla.org/ja/docs/Web/HTTP/Headers)を利用する。SPA ではセキュリティ対策として必要事項。

- ブラウザストレージ(キャッシュ)...セッション情報などクライアント側に情報を格納するためのブラウザに実装されたデータストア。

|                                                                                       | 有効期限                    | データ量 | サーバへのデータ送信　 |
| ------------------------------------------------------------------------------------- | --------------------------- | -------- | ---------------------- |
| [Cookie](https://developer.mozilla.org/ja/docs/Web/HTTP/Cookies)                      | 指定期限まで                | 4KB      | リクエスト毎に自動送信 |
| [LocalStorage](https://developer.mozilla.org/ja/docs/Web/API/Window/localStorage)     | 永続的に有効                | 5MB      | データ利用時のみ       |
| [SessionStorage](https://developer.mozilla.org/ja/docs/Web/API/Window/sessionStorage) | ウィンドウ/タブを閉じるまで | 5MB      | データ利用時のみ       |

- [JWT(Json Web Token)](https://jwt.io/)...Base64 でエンコーディングされた認証トークン。API 利用者は JWT を HTTP リクエストヘッダーに含めてリクエストを送信する。
  ![](https://res.cloudinary.com/dso4npatn/image/upload/v1647150483/media/blog/insert/jwt_generate_fsodlb.png)

> [【JWT】 入門 - Qiita](https://qiita.com/Naoto9282/items/8427918564400968bd2b)

## 認証 API 設計方針

あくまで独自にこうしてみたという認証 API の設計方針を紹介します。(OAuth については触れません)

フレームワーク付属のテンプレートエンジンではなく、React や Vue.js などの疎結合なフロントエンドフレームワークを使う機会がほとんどなのでそれ向けの設計を考察します。サーバーサイドフレームワークが Web ページ生成から返却までするようなフレームワークは範囲外です。以下の３つを留意事項としました。

- データ取得はエンドポイントを叩いたら json でデータを返すだけのシンプルな設計にする(ステートレスな RESTful API)
- HTTP レスポンスを返すエラーハンドリングを施す
- フロント-バックエンド間はセッション管理ではなく、認証トークンを利用したリクエストを構築する(ただし、この認証トークンをどのように管理していくかがセキュリティ上の課題)

認証トークンを発行して利用するフローは以下の通りです。
![](https://res.cloudinary.com/dso4npatn/image/upload/v1647150483/media/blog/insert/auth_flow_diagram_nxoq1k.png)

#### ユーザー登録処理

1. (クライアント)認証情報<メールアドレス＆パスワード>を送信
2. (サーバー)ID を生成してアカウント情報と一緒に一時アカウントテーブルに保存
3. (サーバー)ユーザーに認証 URL を生成して送付
4. (クライアント)届いた認証 URL から登録送信
5. (サーバー)ID に該当する一時アカウントテーブルのアカウントを、正式なアカウントテーブルへ登録

#### ログイン処理/API リクエスト

1. (クライアント)認証情報<メールアドレス＆パスワード>を送信
2. (サーバー)アカウントテーブルに存在すれば ID をもとに JWT を発行して送付
3. (クライアント)JWT を付与した API リクエストを送信
4. (サーバー)JWT を解読して情報が正しければ、リクエストを処理して API のリクエストを処理して返す

#### パスワード再設定処理

1. (クライアント)メールアドレスを送信<-それ以外の認証を入れておくとセキュリティ強化になる
2. (サーバー)メールアドレスに紐づくアカウントがあれば再設定テーブルにユーザーを保存
3. (サーバー)ユーザーに再設定 URL を生成して送付<-URL に有効期限をつけておくとセキュリティ強化になる
4. (クライアント)届いた再設定 URL でパスワードを再設定送信
5. (サーバー)再設定テーブルにユーザーがあれば正式なアカウントテーブルのパスワード情報を更新

## クライアント設計の考慮点

ここからは API をリクエストするクライアント実装の少し細かい話になります。

### 送信する認証情報の暗号化

クライアント API 間の通信は SSL/TSL で暗号化するのは前提になります。HTTPS 通信で URL とリクエストヘッダ/ボディは暗号化されますが、URL については設定によってサーバーのログに残ってしまうので、認証情報については POST 通信のリクエストボディに書いておくようにするのが賢明です。

### JWT の管理設定

JWT を利用して API のリクエストを行うので、JWT が盗まれたらセキュリティとして致命的です。盗まれないような工夫あるいは盗まれても対応できる工夫が必要になってきます。JWT の保存場所としてはクッキーかローカルストレージのいずれかになるでしょう。どちらに保存すべきかはブラウザ開発者の中でも賛否両論があります。
クッキーは HttpOnly 属性と Secure 属性をつけることが前提ですが、CSRF 脆弱性が残るのと全てのリクエストで送信されてしまうのが懸念点です。
ローカルストレージは同一生成元ポリシーを適用しており、シンプルなデータストアでわかりやすいですが、パフォーマンスに優れないなどの指摘があります。
MDN については以下のように記載があるので、今後のブラウザ実装はローカルストレージを推奨していく感じはします。

> Cookie は、クライアント側の汎用的な記憶領域として使用されたことがあります。これは他にクライアントへデータを保存する手段がなかった頃は合理的でしたが、現在では新しいストレージ API を採用することが推奨されます。Cookie はすべてのリクエストで送信されるので、(特にモバイルデータ通信で)効率を悪くする可能性があります。クライアントストレージ向けの新しい API として、Web storage API(localStorage 及び sessionStorage)と IndexedDB があります。
> [HTTP Cookie - HTTP \| MDN](https://developer.mozilla.org/ja/docs/Web/HTTP/Cookies)

どちらを利用するにせよ CSRF や XSS 対策について考慮する必要があります。

### プリフライトリクエスト発生のためのカスタムヘッダー

CORS によって確かにリクエスト結果の読み取りはできませんが、リクエスト送信自体は可能となってしまいます。(CSRF 対策をできたことにはならない)そこで事前に CORS 確認を行えるプリフライトリクエストによって API サーバーへのリクエスト送信自体を防ぐことが可能になります。そのプリフライトリクエスト(OPTIONS という HTTP メソッド)を発生させるためにカスタムヘッダを独自につけることが必要です。多くの場合は`X-Requested-With`をリクエストヘッダにつけておくのが一般的なようです。

```
OPTIONS /resource/foo
Access-Control-Request-Method: DELETE
Access-Control-Request-Headers: origin, x-requested-with
Origin: https://foo.bar.org
```

そもそも[メール&パスワード認証が古いのではないかという説](https://liginc.co.jp/398057)もあり、OAuth はほぼデファクトスタンダードですが、SMS 認証やワンタイムパスワード認証が一般的になってくるかもしれません。ただ今回のようにオーソドックスな認証パターンを学習/実装して骨組みを理解しておけたのは今後の自分にとって土台になりそうです。
