---
date: 2022-11-22T00:00:00+09:00
title: 'Flutterã®Stateç®¡ç†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ ~Providerã¨RiverPod~'
thumbnail: 'https://res.cloudinary.com/dso4npatn/image/upload/v1670179865/media/blog/thumbnail/Flutter_State%E7%AE%A1%E7%90%86_o6ctv5.png'
tag:
  - ãƒã‚¤ãƒ†ã‚£ãƒ–é–‹ç™º
---

![ui-equals-function-of-state.png](https://docs.flutter.dev/assets/images/docs/development/data-and-backend/state-mgmt/ui-equals-function-of-state.png)

React é–‹ç™ºè€…ã‹ã‚‰ã®è¦³ç‚¹ã§ Flutter ã® State ç®¡ç†ã«ã¤ã„ã¦è€ƒãˆã¦ã¿ã‚‹ã€‚

## Flutter ã® state ã®è€ƒãˆæ–¹

- **Ephemeral state**...1 ã¤ã® Stateful Widget ã«å«ã‚ã‚‹ã“ã¨ãŒã§ãã‚‹(åŸºæœ¬çš„ã«`setState`ã§è§£æ±ºã§ãã‚‹)state
- **App state**...è¤‡æ•°ã® Widget ã§å…±æœ‰ã—ã¦ãŠãã¹ã state

> ###### state è¨­è¨ˆã®æ±ºå®šæœ¨
>
> ![ephemeral-vs-app-state.png](https://docs.flutter.dev/assets/images/docs/development/data-and-backend/state-mgmt/ephemeral-vs-app-state.png)

## ãƒ»Provider

https://pub.dev/packages/provider

### æ§‹æˆè¦ç´ 

- `ChangeNotifier`...App State ã®ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã‚’å®šç¾©ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢

```dart
class CartModel extends ChangeNotifier {
  final List<Item> _items = [];

  UnmodifiableListView<Item> get items => UnmodifiableListView(_items);

  int get totalPrice => _items.length * 42;

  void add(Item item) {
    _items.add(item);
    notifyListeners(); // ã“ã®CartModelã‚’è³¼èª­ã—ã¦ã„ã‚‹Widgetã«å¤‰æ›´ã‚’é€šçŸ¥ã™ã‚‹
  }

  void removeAll() {
    _items.clear();
    notifyListeners(); // ã“ã®CartModelã‚’è³¼èª­ã—ã¦ã„ã‚‹Widgetã«å¤‰æ›´ã‚’é€šçŸ¥ã™ã‚‹
  }
}
```

- `ChangeNotifierProvider`...ã“ã‚Œã‚’å¿…è¦ãª Widget ã«ãƒ©ãƒƒãƒ—ã™ã‚‹ã“ã¨ã§ Widget ãŒ App State ã®å€¤ã«ã‚¢ã‚¯ã‚»ã‚¹(`Consumer`ã‚„`Provider.of`)ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹

```dart
void main() {
  runApp(
    ChangeNotifierProvider(
      create: (context) => CartModel(),
      child: const MyApp(),
    ),
  );
}
```

- `Consumer`...ã“ã‚Œã‚’ãƒ©ãƒƒãƒ—ã™ã‚‹ã“ã¨ã§åæ˜ ã•ã‚Œã‚‹(å¤‰æ›´ãŒã‚ã£ãŸå ´åˆãƒªãƒ“ãƒ«ãƒ‰ãŒèµ°ã‚‹)ã‚ˆã†ã«ãªã‚‹ã€‚

```dart
return Consumer<CartModel>( // ChangeNotifierã‚’ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ã«ä½¿ã†
  builder: (context, cart, child) {
    return Text('Total price: ${cart.totalPrice}');
  },
);
```

- `Provider.of`...ãƒªãƒ“ãƒ«ãƒ‰ãŒå¿…è¦ãªã„å ´åˆã¯ã“ã¡ã‚‰ã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šå¤‰æ›´ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ãŸã‚Šã™ã‚‹

```dart
Provider.of<CartModel>(context, listen: false).removeAll();
```

`listen`ã‚’`true`ã«ã™ã‚‹ã¨`context.dependOnInheritedWidgetOfExactType`ã‚’å‘¼ã³å‡ºã™ã€‚ã¤ã¾ã‚Šç›£è¦–æ©Ÿèƒ½ã¨è‡ªå‹•ãƒªãƒ“ãƒ«ãƒ‰æ©Ÿèƒ½ãŒæœ‰åŠ¹ã«ãªã‚‹ã€‚
`false`ã«ã™ã‚‹ã¨`context.getElementForInheritedWidgetOfExactType`ã‚’å‘¼ã³å‡ºã™ã€‚

## ãƒ»Riverpod

https://riverpod.dev/ja/docs/getting_started/

### æ§‹æˆè¦ç´ 

- `Provider`...Riverpod ã§ã¯æ§˜ã€…ãªç”¨é€”ã«å¿œã˜ãŸ Provider ãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹

ä½¿ç”¨ã™ã‚‹éš›ã¯`final`ã§å®£è¨€ã™ã‚‹ã€‚`ref`ã¯ä¾å­˜ã™ã‚‹ä»–ã® Provider ã‚’å‚ç…§ã—ãŸã‚Šã€state ãŒç ´æ£„ã•ã‚Œã‚‹éš›ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’ç™»éŒ²ã§ãã‚‹ã€‚

```dart
// Providerãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã„ã†Provider.of(context)ã«ã‚ãŸã‚‹ã£ã½ã„
final myProvider = Provider((ref) {
  return MyValue();
});
```

`ref`ã«ã¯ 3 ã¤ã®ä½¿ã„æ–¹ãŒå­˜åœ¨ã™ã‚‹ã€‚([Ref ã‚¯ãƒ©ã‚¹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://pub.dev/documentation/riverpod/latest/riverpod/Ref-class.html))

- `ref.watch`...å€¤ã‚’å–å¾—ã—ã¦ãã®å¤‰æ›´ã‚’ç›£è¦–ãƒ»Wiget ã®ãƒªãƒ“ãƒ«ãƒ‰ãƒ»Provider ã®å€¤æ›´æ–°ã‚’å®Ÿæ–½ã™ã‚‹ã€‚
- `ref.listen`...å€¤ã‚’ç›£è¦–ã—ã¦ã€å¤‰åŒ–ã™ã‚‹åº¦ã«ç™»éŒ²ã—ãŸã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’å‘¼ã³å‡ºã™ã€‚
- `ref.read`...å€¤ã®å–å¾—ã®ã¿(ç›£è¦–ã¯ã—ãªã„)
- `ref.refresh`...Provider ã®å€¤ã®ãƒªã‚»ãƒƒãƒˆ

Widget ã®æ›´æ–°å›æ•°ã‚’æŠ‘ãˆã‚‹ãŸã‚ã«`ref.read`ã‚’ä½¿ã†ã¨ã„ã†å¿ƒé…ã¯ä¸è¦(`ref.watch`ã®æ–¹ãŒã‚³ã‚¹ãƒˆãŒé«˜ã„ã¨ã„ã†å†…éƒ¨å®Ÿè£…ã‚’ã—ã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªã„)ã§æœ€åˆã‹ã‚‰ **`ref.watch`ã‚’ä½¿ã†ã“ã¨ãŒæ¨å¥¨** ã•ã‚Œã¦ã„ã‚‹ã€‚

ä»–ã® Provider ã‚’å‚ç…§ã™ã‚‹å ´åˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã€‚

```dart:weatherProviderã¯cityProviderã«ä¾å­˜ã™ã‚‹
final cityProvider = Provider((ref) => 'London');

final weatherProvider = FutureProvider((ref) async {
  // `ref.watch` ã«ã‚ˆã‚Šä»–ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ã®å€¤ã‚’å–å¾—ãƒ»ç›£è¦–ã—ã¾ã™ã€‚
  // åˆ©ç”¨ã™ã‚‹ãƒ—ãƒ­ãƒã‚¤ãƒ€ï¼ˆã“ã“ã§ã¯ cityProviderï¼‰ã‚’å¼•æ•°ã¨ã—ã¦æ¸¡ã—ã¾ã™ã€‚
  final city = ref.watch(cityProvider);

  // æœ€å¾Œã« `cityProvider` ã®å€¤ã‚’ã‚‚ã¨ã«è¡Œã£ãŸè¨ˆç®—çµæœã‚’è¿”ã—ã¾ã™ã€‚
  return fetchWeather(city: city);
});
```

###### ğŸ‘‰Provider ã®å„ç¨®ç”¨é€”

| ãƒ—ãƒ­ãƒã‚¤ãƒ€ã®ç¨®é¡                                                                          | ç”Ÿæˆã•ã‚Œã‚‹ã‚¹ãƒ†ãƒ¼ãƒˆã®å‹      | å…·ä½“ä¾‹                                                                     |
| ----------------------------------------------------------------------------------------- | --------------------------- | -------------------------------------------------------------------------- |
| [Provider](https://riverpod.dev/ja/docs/providers/provider/)                              | ä»»æ„                        | ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹ / ç®—å‡ºãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ï¼ˆãƒªã‚¹ãƒˆã®ãƒ•ã‚£ãƒ«ã‚¿ãªã©ï¼‰                    |
| [StateProvider](https://riverpod.dev/ja/docs/providers/state_notifier_provider)           | ä»»æ„                        | ãƒ•ã‚£ãƒ«ã‚¿ã®æ¡ä»¶ / ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¹ãƒ†ãƒ¼ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ                            |
| [FutureProvider](https://riverpod.dev/ja/docs/providers/future_provider)                  | ä»»æ„ã® Future               | API ã®å‘¼ã³å‡ºã—çµæœ                                                         |
| [StreamProvider](https://riverpod.dev/ja/docs/providers/stream_provider)                  | ä»»æ„ã® Stream               | API ã®å‘¼ã³å‡ºã—çµæœã® Stream                                                |
| [StateNotifierProvider](https://riverpod.dev/ja/docs/providers/state_provider)            | StateNotifier ã®ã‚µãƒ–ã‚¯ãƒ©ã‚¹  | ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ï¼ˆã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä»‹ã•ãªã„é™ã‚Šï¼‰ã§è¤‡é›‘ãªã‚¹ãƒ†ãƒ¼ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ |
| [ChangeNotifierProvider](https://riverpod.dev/ja/docs/providers/change_notifier_provider) | ChangeNotifier ã®ã‚µãƒ–ã‚¯ãƒ©ã‚¹ | ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ã§è¤‡é›‘ãªã‚¹ãƒ†ãƒ¼ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ                                   |

- `ProviderScope`...**ã‚¢ãƒ—ãƒªã®ãƒ«ãƒ¼ãƒˆ**ã‚’ ProviderScope ã§ãƒ©ãƒƒãƒ—ã™ã‚‹ã“ã¨ã§ Provider ã®åˆ©ç”¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚

```dart
void main() {
  runApp(ProviderScope(child: MyApp()));
}
```

- `Provider.autoDispose`...ç›£è¦–çµ‚äº†æ™‚(Provider ãŒå‚ç…§ã•ã‚Œãªããªã£ãŸæ™‚)ã« State ã®å€¤ã‚’è‡ªå‹•ã§å»ƒæ£„ã•ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹

autoDipose é–¢æ•°ã‚’å®šç¾©ã™ã‚‹ã¨`ref.keepAlive`ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚`ref.keepAlive`ã¯ Provider ãŒå‚ç…§ã•ã‚Œãªããªã£ãŸéš›ã«ã‚‚ State ã‚’ç¶­æŒã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚

```dart:ãƒªã‚¯ã‚¨ã‚¹ãƒˆå®Œäº†å¾Œã«åˆ¥ç”»é¢ã«é·ç§»ã—ã¦ã‹ã‚‰æˆ»ã£ã¦ããŸæ™‚ã«ã€Stateã‚’ç¶­æŒã—ã¦ã„ã‚‹(å†ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ãªã„)ä¾‹
final myProvider = FutureProvider.autoDispose((ref) async {
  final response = await httpClient.get(...);
  ref.keepAlive(); // autoDiposeé–¢æ•°å†…ã§ref.keepAliveãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹
  return response;
});
```

- `Provider.family`...å¤–éƒ¨ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã‚‚ã¨ã«ä¸€æ„ã® Provider ã‚’ä½œæˆã™ã‚‹

```dart
final messagesFamily = FutureProvider.family<Message, String>((ref, id) async {
  return dio.get('http://my_api.dev/messages/$id');
});

// Widgetã§åˆ©ç”¨ã™ã‚‹
Widget build(BuildContext context, WidgetRef ref) {
  final response = ref.watch(messagesFamily('id'));
}
```

## çµè«–ï¼šã¨ã‚Šã‚ãˆãš Riverpod ã‚’ä½¿ã£ã¦ã¿ã‚‹

å€‹äººçš„ã«ä»¥ä¸‹ã® 2 ç‚¹ãŒ Riverpod ã‚’ä½¿ã†ã“ã¨ã§äº«å—ã§ããã†ãªãƒ¡ãƒªãƒƒãƒˆã ã¨æ„Ÿã˜ãŸã€‚

- å®šç¾©ã—ãŸ Provider ã® State åŒå£«ã®ä¾å­˜é–¢ä¿‚ãŒå®Ÿè£…ã—ã‚„ã™ãã†
- API ã§å–å¾—ã—ãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã¨ State ã®é€£æºãŒå–ã‚Šã‚„ã™ãã†

è‡ªåˆ†ã® React ã®é–‹ç™ºã§ã¯æ™®æ®µ AppState ã§ç®¡ç†ã—ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã®ã“ã¨ã‚’ã€Œã‚¹ãƒˆã‚¢ã€ã¨å‘¼ã‚“ã§ã„ã‚‹ãŒã€ãã®ã‚¹ãƒˆã‚¢ã®ãƒ‡ãƒ¼ã‚¿ãŒä»–ã®ã‚¹ãƒˆã‚¢ã«ä¾å­˜ã—ã¦å¤‰æ›´ãŒè¡Œã‚ã‚Œã‚‹ã“ã¨ã¯é–‹ç™ºã—ã¦ã„ã¦ã‚ˆãèµ·ãã‚‹ã€‚ä¾‹ãˆã°ã‚¢ãƒ—ãƒªã«è¤‡æ•°å‚åŠ ã§ãã‚‹ã‚°ãƒ«ãƒ¼ãƒ—æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã„ã¦åˆ¥ã‚°ãƒ«ãƒ¼ãƒ—ã«åˆ‡ã‚Šæ›¿ãˆãŸéš›ã«ã€ãã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚¹ãƒˆã‚¢ã®å¤‰æ›´ã«ä¼´ã£ã¦ä»–ã®ã‚¹ãƒˆã‚¢ãŸã¡ã®å€¤ã‚‚åˆæœŸåŒ–ã—ãŸã‚Š API ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå†ç™ºç”Ÿã™ã‚‹ãªã©ã§ã‚ã‚‹ã€‚

ã•ã‚‰ã« Component(Flutter ãªã‚‰ Widget)ã® State ã®å€¤ã¯ API ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã«å½±éŸ¿ã‚’å—ã‘ã¦ãƒªãƒ“ãƒ«ãƒ‰ãŒèµ°ã‚‹ã“ã¨ã‚‚ã‚ˆãèµ·ãã‚‹ã€‚ä¾‹ãˆã°è¡¨ç¤ºã—ã¦ã„ã‚‹ãƒªã‚¹ãƒˆã®æƒ…å ±ã‚’å¤‰æ›´ã—ã¦ä¿å­˜ â†’ æˆåŠŸã®ã‚¹ãƒŠãƒƒã‚¯ãƒãƒ¼ã‚’è¡¨ç¤º â†’ ãƒªã‚¹ãƒˆã‚’æ›´æ–°(mutate)ã¿ãŸã„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã€‚State ã®å€¤ã‚‚ãã®çµæœã¨é€£æºã—ã¦å½±éŸ¿ã‚’å—ã‘ã‚‹ã“ã¨ã¯ã‚ã‚‹ã®ã§ Riverpod ã ã¨ãã“ã‚‰è¾ºã® API ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã¨ State ã®æ›´æ–°ãŒã†ã¾ãã„ããã†ãªã‚¤ãƒ¡ãƒ¼ã‚¸ãŒæ¹§ã„ãŸã€‚
