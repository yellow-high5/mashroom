---
date: 2022-12-03T23:00:00Z
title: 'Dartã®éåŒæœŸå‡¦ç† ~Futureã¨Stream~'
thumbnail: 'https://res.cloudinary.com/dso4npatn/image/upload/v1670179867/media/blog/thumbnail/Flutter_%E9%9D%9E%E5%90%8C%E6%9C%9F%E5%87%A6%E7%90%86_bfkmuw.png'
tag:
  - ãƒã‚¤ãƒ†ã‚£ãƒ–é–‹ç™º
---

Dart ã§ã¯éåŒæœŸå‡¦ç†ã®å˜ä¸€çš„ãªçµæœã¯ Futureã€ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã®ã‚ˆã†ãªé€£ç¶šçš„çµæœã¯ã¯ Stream ã‚’è¿”ã™ã€‚
ãã‚Œãã‚Œã®ã‚¯ãƒ©ã‚¹ã«ç”¨æ„ã•ã‚ŒãŸé–¢æ•°ã®ä½¿ã„æ–¹ã‚„ Builder Widget ã«ã¤ã„ã¦å…¬å¼ã‚’èª­ã¿ãªãŒã‚‰ç¢ºèªã—ãŸã€‚

## Future

> - [Asynchronous programming: futures, async, await \| Dart](https://dart.dev/codelabs/async-await#exercise-practice-handling-errors)
> - [Dart Futures - Flutter in Focus - YouTube](https://www.youtube.com/watch?v=OTS-ap9_aXc)
>   <Youtube embededSrc="https://www.youtube.com/embed/OTS-ap9_aXc" />

- `Future`...å®Œäº†(æˆåŠŸã™ã‚Œã°`<T>`(å€¤)ã‚’è¿”ã—ã€ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™)ã‹æœªå®Œäº†ã®çŠ¶æ…‹ã€‚`Future`ã‚’è¿”ã™é–¢æ•°ã‚’å‘¼ã³å‡ºã™ã¨ã€é–¢æ•°ã¯å®Ÿè¡Œã™ã‚‹ä½œæ¥­ã‚’ã‚­ãƒ¥ãƒ¼ã«å…¥ã‚Œã¦æœªå®Œäº†ã®`Future`ã‚’è¿”ã™ã€‚
- future...Future ã‚¯ãƒ©ã‚¹ã§ç”Ÿæˆã•ã‚ŒãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
- `async`...`Future<T>`ã‚’è¿”ã™éåŒæœŸé–¢æ•°ã®å‰ã«ã¤ã‘ã‚‹
- `await`...`async`ãŒä»˜ã„ãŸé–¢æ•°å†…ã§ã€éåŒæœŸå‡¦ç†ã®å®Œäº†çµæœã‚’å–å¾—ã™ã‚‹

```dart
Future<String> createOrderMessage() async {
  var order = await fetchUserOrder();
  return 'Your order is: $order';
}

Future<String> fetchUserOrder() =>
    // Imagine that this function is
    // more complex and slow.
    Future.delayed(
      const Duration(seconds: 2),
      () => 'Large Latte',
    );

Future<void> main() async {
  print('Fetching user order...');
  print(await createOrderMessage());
}
```

### ã‚¨ãƒ©ãƒ¼å‡¦ç†

ã‚¨ãƒ©ãƒ¼å‡¦ç†ã«ã¤ã„ã¦ã¯ try-catch æ§‹æ–‡ã¾ãŸã¯ then ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã†ã€‚

> - [Futures and error handling \| Dart](https://dart.dev/guides/libraries/futures-error-handling)

```dart
// try-catch
try {
  print('Awaiting user order...');
  var order = await fetchUserOrder();
} catch (err) {
  print('Caught error: $err');
}

// then
fetchUserOrder().then((value) => print('Order is $value'), onError: (e) => print('Caught error: $err')
// catchErrorã®æ–¹ãŒæ•æ‰ç¯„å›²ã¯åºƒã„(onErrorã¯onValueã§ç™ºç”Ÿã—ãŸã‚¨ãƒ©ãƒ¼ã®ã¿ã®æ•æ‰)
fetchUserOrder().then((value) => print('Order is $value')).catchError((e) => print('Caught error: $err')
```

`onError`ã¨`catchError`ã®ç•°ãªã‚‹ç‚¹ã¯ã€then ã®`onValue`(then ãƒ¡ã‚½ãƒƒãƒ‰ã®æœ€åˆã®å¼•æ•°)ã‚„`onError`ã§ç™ºç”Ÿã—ãŸä¾‹å¤–ã‚’å‡¦ç†ã§ãã‚‹ã‹ã©ã†ã‹ã«é•ã„ã‚ã‚‹ã€‚`onError`ã ã¨`onValue`ã§ç™ºç”Ÿã—ãŸã‚¨ãƒ©ãƒ¼ã¯æ•æ‰ã§ããªã„ãŒã€`catchError`ã‚’ä½¿ãˆã°æ•æ‰ã™ã‚‹ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚

```dart:onErrorã®ã‚¨ãƒ©ãƒ¼ã‚’catchErrorãŒæ•æ‰ã™ã‚‹ä¾‹
funcThatThrows().then(successCallback, onError: (e) {
  handleError(e);           // Original error.
  anotherFuncThatThrows();  // Oops, new error.
}).catchError(handleError); // Error from within then() handled.
```

ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚¨ãƒ©ãƒ¼ã®å†…å®¹ã‚’è­˜åˆ¥ã—ã¦æ•æ‰ã§ãã‚‹ã®ã§`onError`ã‚ˆã‚Š`catchError`ã‚’ä½¿ã†é »åº¦ã®æ–¹ãŒå¤šãã†ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã€‚

```dart
void main() {
  handleAuthResponse(const {'username': 'dash', 'age': 3})
      .then((_) => ...)
      .catchError(handleFormatException, test: (e) => e is FormatException)
      .catchError(handleAuthorizationException, test: (e) => e is AuthorizationException);
}
```

### whenComplete

`try-catch-finally`ã§ã„ã†ã¨ã“ã‚ã®`finally`ã«ã‚ãŸã‚‹ã€‚ã‚¨ãƒ©ãƒ¼ã«é–¢ä¿‚ãªãç¢ºå®Ÿã«æœ€å¾Œã«å®Ÿè¡Œã•ã‚Œã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã€‚

```dart
final server = connectToServer();
server
    .post(myUrl, fields: const {'name': 'Dash', 'profession': 'mascot'})
    .then(handleResponse)
    .catchError(handleError)
    .whenComplete(server.close);
```

### Future ã‚¯ãƒ©ã‚¹ã§ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰

- `Future.value()`...Future ã®å®Ÿè¡ŒçµæœãŒæˆåŠŸã ã£ãŸå ´åˆã®å€¤ã‚’è¿”ã™ã€‚
- `Future.error()`...Future ã®å®Ÿè¡ŒçµæœãŒå¤±æ•—ã ã£ãŸå ´åˆã®ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã€‚
- `Future.delayed()`...å®Ÿè¡Œã™ã‚‹é–¢æ•°ã‚’æŒ‡å®šã—ãŸæ™‚é–“ã ã‘é…ã‚‰ã›ã‚‹(Flutter ã§èª­ã¿è¾¼ã¿ã‚¹ãƒ”ãƒŠãƒ¼ã‚’è¡¨ç¤ºã—ãŸã„ã¨ããªã©ã«ä¾¿åˆ©)

```dart
Future.delayed(const Duration(milliseconds: 500), () {
    future.then(...).catchError(...);
  });
}
```

- `Future.sync()`...1 ã¤ã®é–¢æ•°ã®ä¸­ã«åŒæœŸã‚¨ãƒ©ãƒ¼ã¨éåŒæœŸã‚¨ãƒ©ãƒ¼ãŒæ··ã˜ã‚‹å ´åˆã«ã€åŒæœŸã‚¨ãƒ©ãƒ¼ã«ã‚ˆã£ã¦ã‚¨ãƒ©ãƒ¼ãŒæ•æ‰ã§ããªã„ã“ã¨ã‚’é˜²ãã€‚

```dart
Future<int> parseAndRead(Map<String, dynamic> data) {
  return Future.sync(() {
    final filename = obtainFilename(data); // Could throw synchronous error.
    final file = File(filename);
    return file.readAsString().then((contents) {
      return parseFileData(contents); // Could throw asynchronous error.
    });
  });
}

void main() {
  parseAndRead(data).catchError((e) {
    print('Inside catchError');
    print(e);
    return -1;
  });
}

// å®Ÿè¡Œçµæœ:
// Inside catchError  <=ã‚‚ã—Future.syncã§ãƒ©ãƒƒãƒ—ã—ã¦ã„ãªã‘ã‚Œã° `Unhandled exception`ã«ãªã£ã¦ã—ã¾ã†
// <error from obtainFilename>
```

### FutureBuilder

Flutter ã§éåŒæœŸå‡¦ç†ã®çµæœ(å–å¾—ä¸­(æœªå®Œäº†)ã€å®Œäº†ã€ã‚¨ãƒ©ãƒ¼)ã«å¿œã˜ã¦ Widget ã‚’è¡¨ç¤ºã—ãŸã„å ´åˆã«ä½¿ã†ã€‚
`future`ã«éåŒæœŸé–¢æ•°ã¨`builder`ã«è¡¨ç¤ºã—ãŸã„ Widget ã‚’æŒ‡å®šã™ã‚‹ã€‚

> - [FutureBuilder class - widgets library - Dart API](https://api.flutter.dev/flutter/widgets/FutureBuilder-class.html)

```dart
class _MyStatefulWidgetState extends State<MyStatefulWidget> {
  final Future<String> _calculation = Future<String>.delayed(
    const Duration(seconds: 2),
    () => 'Data Loaded',
  );

  @override
  Widget build(BuildContext context) {
    return DefaultTextStyle(
      style: Theme.of(context).textTheme.headline2!,
      textAlign: TextAlign.center,
      child: FutureBuilder<String>(
        future: _calculation, // ã“ã®ä¾‹ã§ã¯Future<String> or nullã‚’è¿”ã™éåŒæœŸå‡¦ç†
        builder: (BuildContext context, AsyncSnapshot<String> snapshot) {
          List<Widget> children;
          if (snapshot.hasData) {
            // ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†æ™‚
          } else if (snapshot.hasError) {
            // ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼æ™‚
          } else {
            // å–å¾—ä¸­çŠ¶æ…‹(ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒ¼ãªã©ã®Widgetã‚’è¡¨ç¤º)
        },
      ),
    );
  }
}
```

## Stream

â†“ Future ã‚„ Stream ã¨ã¯ä½•ã‹ã‚’è¡¨ç¾ã—ãŸåŒæœŸãƒ‡ãƒ¼ã‚¿ã‚„å˜ä¸€ãƒ‡ãƒ¼ã‚¿ã¨ã®æ¯”è¼ƒè¡¨

| åŒæœŸ/éåŒæœŸ |       å˜ä¸€       |     ã‚·ãƒ¼ã‚±ãƒ³ã‚¹     |
| :---------- | :--------------: | :----------------: |
| Sync        |     **int**      | **Iterator<int\>** |
| Async       | **Future<int\>** |  **Stream<int\>**  |

> - [Asynchronous programming: Streams \| Dart](https://dart.dev/tutorials/language/streams)
> - [Dart Streams - Flutter in Focus - YouTube](https://www.youtube.com/watch?v=nQBpOIHE4eE)
>   <Youtube embededSrc="https://www.youtube.com/embed/nQBpOIHE4eE" />

- `*async`...ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‹ã‚‰ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°(å®Ÿéš›ã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãªã©ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã®ã§ã‚¢ãƒ—ãƒªé–‹ç™ºè€…ã¯ã“ã‚Œã‚’å‘¼ã³å‡ºã™ã‚¤ãƒ¡ãƒ¼ã‚¸)

```dart
Stream<int> countStream(int to) async* {
  for (int i = 1; i <= to; i++) {
    yield i;
  }
}
```

- `listen`...ãƒ‡ãƒ¼ã‚¿ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å—ä¿¡ã™ã‚‹ stream subscription ã‚’ç”Ÿæˆã™ã‚‹ã€‚(ç”Ÿæˆã•ã‚ŒãŸ subscription ã¯)

```dart
final myStream = NumberCreator().stream;

final subscription = myStream.listen(
  (data) => print('Data: $data'),
  onError: (err) => print('Error!'),
  cancelOnError: false,
  onDone: () => print('Done!'),
);

// subscriptionã«ç”¨æ„ã•ã‚ŒãŸãƒ¡ã‚½ãƒƒãƒ‰
subscription.puase();
subscription.resume();
subscription.cancel();
```

ã‚¹ãƒˆãƒªãƒ¼ãƒ ã§ã¯ã€ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹éš›ã« 2 ç¨®é¡ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ (`Single subscription streams`(ä¸€èˆ¬çš„)ã¨`Broadcast streams`)ãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã€‚

##### Single subscription streams

ä¸€é€£ã®ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ­£ã—ã„é †åºã§æ¬ è½ã›ãšå—ã‘å–ã‚‹ã€‚

```dart
final myStream = NumberCreator().stream;

final subscription = myStream.listen(
  (data) => print('Data: $data'),
);

// ã“ã®subscriptionã¯è¨±ã•ã‚Œãªã„ğŸ™…â€
final subscription2 = myStream.listen(
  (data) => print('Data again: $data'),
);
```

##### Broadcast streams

è¤‡æ•°ã®ãƒªã‚¹ãƒŠãƒ¼ã§åŒæ™‚ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚

```dart
final myStream = NumberCreator()
    .stream
    .asBroadcastStream; // ã“ã‚Œã§ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆåŒ–

//
final subscription = myStream.listen(
  (data) => print('Data: $data'),
);

// è¤‡æ•°ã®Listenerã‚’æŒã¤ã“ã¨ãŒã§ãã‚‹ğŸ™†
final subscription2 = myStream.listen(
  (data) => print('Data again: $data'),
);
```

### Stream æ“ä½œé–¢æ•°

ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ãƒ¼é–¢æ•°åŒæ§˜ã€`map`ã‚„`where`ã¨ã„ã£ãŸã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åŠ å·¥ã—ãŸã‚Šãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã™ã‚‹é–¢æ•°ãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã€‚

```dart
// åŠ å·¥å‡¦ç†ç³»
Future<T> get first;
Future<bool> get isEmpty;
Future<T> get last;
Future<int> get length;
Future<T> get single;
Future<bool> any(bool Function(T element) test);
Future<bool> contains(Object? needle);
Future<E> drain<E>([E? futureValue]);
Future<T> elementAt(int index);
Future<bool> every(bool Function(T element) test);
Future<T> firstWhere(bool Function(T element) test, {T Function()? orElse});
Future<S> fold<S>(S initialValue, S Function(S previous, T element) combine);
Future forEach(void Function(T element) action);
Future<String> join([String separator = '']);
Future<T> lastWhere(bool Function(T element) test, {T Function()? orElse});
Future pipe(StreamConsumer<T> streamConsumer);
Future<T> reduce(T Function(T previous, T element) combine);
Future<T> singleWhere(bool Function(T element) test, {T Function()? orElse});
Future<List<T>> toList();
Future<Set<T>> toSet();

// å¤‰æ›´ç³»
Stream<R> cast<R>();
Stream<S> expand<S>(Iterable<S> Function(T element) convert);
Stream<S> map<S>(S Function(T event) convert);
Stream<T> skip(int count);
Stream<T> skipWhile(bool Function(T element) test);
Stream<T> take(int count);
Stream<T> takeWhile(bool Function(T element) test);
Stream<T> where(bool Function(T event) test);
```

### StreamBuilder

> [StreamBuilder class - widgets library - Dart API](https://api.flutter.dev/flutter/widgets/StreamBuilder-class.html)

`stream`ã«éåŒæœŸã‚¹ãƒˆãƒªãƒ¼ãƒ é–¢æ•°ã¨`builder`ã«è¡¨ç¤ºã—ãŸã„ Widget ã‚’æŒ‡å®šã™ã‚‹ã€‚
`builder`ã®å†…éƒ¨ã§ã¯`snapshot.connectionState`ã«å¿œã˜ã¦ Widget ã®è¡¨ç¤ºã‚’å¤‰æ›´ã—ã¦ã„ã‚‹ã€‚

```dart:StreamBuilderã®ä½¿ã„æ–¹(ä¾‹ã§ã¯StreamControllerã‚’ä½¿ã£ã¦Streamã‚’ä½œæˆã—ã¦ã„ã‚‹)
class _MyStatefulWidgetState extends State<MyStatefulWidget> {
  final Stream<int> _bids = (() {
    late final StreamController<int> controller;
    controller = StreamController<int>(
      onListen: () async {
        await Future<void>.delayed(const Duration(seconds: 1));
        controller.add(1);
        await Future<void>.delayed(const Duration(seconds: 1));
        await controller.close();
      },
    );
    return controller.stream;
  })();

  @override
  Widget build(BuildContext context) {
    return StreamBuilder<int>(
      stream: _bids,
      builder: (BuildContext context, AsyncSnapshot<int> snapshot) {
        List<Widget> children;
        if (snapshot.hasError) {
          children = <Widget>[...];
        } else {
          switch (snapshot.connectionState) {
            case ConnectionState.none:
              children = <Widget>[...];
              break;
            case ConnectionState.waiting:
              children <Widget>[...];
              break;
            case ConnectionState.active:
              children = <Widget>[...];
              break;
            case ConnectionState.done:
              children = <Widget>[...];
              break;
          }
        }

        return Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: children,
        );
      },
    );
  }
}
```

<br />
<br />
<br />

`Future`ã¯ Node.js ã§ã„ã†ã¨ã“ã‚ã®`Promise`ã‚„`async/await`ã¨ã‚ã¾ã‚Šå¤‰ã‚ã‚‰ãªã„ãªã¨è¨€ã£ãŸå°è±¡ã ã£ãŸä¸€æ–¹ã€`Stream`ã«ã¤ã„ã¦ã¯ãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚’çŸ¥ã‚‰ãªã‹ã£ãŸè‡ªåˆ†ã«ã¨ã£ã¦ã¯ã€Œãªã‚‹ã»ã©ãª(ç°¡æ½”ã§ã‚ã‹ã‚Šã‚„ã™ã„ãªãƒ¼)ã€ã¨ã„ã†å°è±¡ã ã£ãŸã€‚
