---
date: 2023-06-03T19:00:00+09:00
title: Supabaseã®Database Functionsã¨Triggerã§ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‹ã‚‰å‘¼ã³å‡ºã™å®Ÿè£…ã‚’å‰Šæ¸›ã™ã‚‹
thumbnail: 'https://res.cloudinary.com/dso4npatn/image/upload/v1685767652/media/blog/thumbnail/supabase_pkilxp.png'
tag:
  - å®Ÿè£…ãƒã‚¿å¸³
---

ä¾‹ãˆã°ã€Supbase x Flutter ã§é–‹ç™ºã—ã¦ã„ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã™ã‚‹ãƒœã‚¿ãƒ³ã«ãŠã„ã¦ä»¥ä¸‹ã®ã‚ˆã†ãª Flutter ã®ã‚³ãƒ¼ãƒ‰ãŒã‚ã£ãŸã¨ã™ã‚‹ã€‚

```dart
// ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©
  +-----------------+        +-----------------+
  |      Room       |        |       User      |
  +-----------------+        +-----------------+
  |   * id (PK)     |        |   * id (PK)     |
  |    roomKey      |        |      name       |
  |    hostId       |------->|   roomId (FK)   |
  |   createdAt     |        |     isHost      |
  +-----------------+        |   createdAt     |
                             +-----------------+

// ãƒ¦ãƒ¼ã‚¶ãƒ¼(ä¸»å‚¬è€…)ã®ä½œæˆã¨åŒæ™‚ã«ãƒ«ãƒ¼ãƒ ã‚‚ä½œæˆã™ã‚‹ãƒœã‚¿ãƒ³
TextButton(
  onPressed: () async {
    supabase
        .from('user')
        .insert([
          {'name': 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å', 'is_host': true, 'room_id': null}
        ])
        .select()
        .single()
        .then((value) {
          final user = User.fromMap(map: value);
          supabase // ðŸ”« ãƒ¦ãƒ¼ã‚¶ãƒ¼(ä¸»å‚¬è€…)ä½œæˆã«æˆåŠŸã—ãŸã‚‰ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã™ã‚‹
              .from('room')
              .insert([
                {'host_id': user.id}
              ])
              .select()
              .single()
              .then((value) {
                final room =
                    Room.fromMap(map: value, myUserId: user.id);
                supabase // ðŸ”« ãƒ«ãƒ¼ãƒ ä½œæˆã«æˆåŠŸã—ãŸã‚‰ãƒ«ãƒ¼ãƒ IDã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼(ä¸»å‚¬è€…)ã«ç´ä»˜ã‘ã‚‹
                    .from('user')
                    .update({'room_id': room.id})
                    .eq('id', user.id)
                    .then((_) {
                      PushNavigator(context)
                          .push(route: RoomPage.route());
                      context.showSuccessSnackBar(
                        message: 'ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã—ãŸ',
                      );
                    });
              });
        })
        .catchError((e) {
          context.showErrorSnackBar(message: 'ãƒ«ãƒ¼ãƒ ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
          return null;
        });
  },
  child: const Text(
    'ä½œæˆ',
    style: TextStyle(fontSize: 16),
  ),
),
```

ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¨ã—ã¦ã¯ä»¥ä¸‹ã®é€šã‚Šã€‚

1. `INSERT`: ãƒ¦ãƒ¼ã‚¶ãƒ¼(ä¸»å‚¬è€…)ã‚’ä½œæˆ
2. `INSERT`: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® id ã‚’ host_id ã«ãªã‚‹ã‚ˆã†ã«ã—ã¦ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ
3. `UPDATE`: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® room_id ã«ä½œæˆã—ãŸãƒ«ãƒ¼ãƒ ã® id ã‚’ã‚»ãƒƒãƒˆã—ã¦æ›´æ–°ã™ã‚‹

DB ã«å¯¾ã™ã‚‹éžåŒæœŸå‡¦ç†ã‚’ 3 å›žã‚„ã£ã¦ã„ã‚‹ã®ã§ã€`then` ãŒ 3 å›žå‡ºç¾ã—ã¦ã„ã‚‹ã€‚ã€‚ã¿ãŸã„ãªæ„Ÿã˜ã€‚

ã“ã®å®Ÿè£…ã§ã‚‚ã„ã„ãŒã€ã“ã®ã‚ˆã†ãª 1 ã¤ã®å‡¦ç†ã‚’å¥‘æ©Ÿã«å‡¦ç†ã‚’ã¾ãŸãå ´åˆã¯ã€[Database Functions](https://supabase.com/docs/guides/database/functions) ã¨ [Trigger](https://supabase.com/docs/guides/auth/managing-user-data#using-triggers) ã‚’ä½¿ã†ã®ãŒä¾¿åˆ©ã€‚

Database Functions ã¨ Trigger è‡ªä½“ã¯ã€å¾“æ¥ã‹ã‚‰ã‚ã‚‹ PostgreSQL ã®æ©Ÿèƒ½ã€‚Supabase ã¯ãã‚Œã‚’ãƒ©ãƒƒãƒ—ã—ã¦æŠ½è±¡åŒ–ã—ã¦ã„ã‚‹ã ã‘ã§ã‚ã‚‹ã€‚(ãªã®ã§ã“ã®è©±è‡ªä½“ã¯ PostgreSQL æ¨™æº–ã®æ©Ÿèƒ½ã‚’ä½¿ã£ãŸãŠè©±)

ä»¥ä¸‹ã®ã‚ˆã†ãª SQL ã‚¯ã‚¨ãƒªã‚’ Supabase ã® SQL ã‚¨ãƒ‡ã‚£ã‚¿ä¸Šã§å®Ÿè¡Œã™ã‚‹ã€‚

```sql
-- ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã™ã‚‹Function
create or replace function public.handle_create_room() returns trigger as $$
    begin
        insert into public.room(host_id) values(new.id);

        return new;
    end;
$$ language plpgsql security definer;

-- ãƒ›ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆæ™‚ã«ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã™ã‚‹ã™ã‚‹Trigger
drop trigger if exists on_new_host_user_created on public.user;
create trigger on_new_host_user_created
    after insert on public.user
    for each row
    when(new.is_host = true)
    execute function handle_create_room();

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«room_idã‚’ã‚»ãƒƒãƒˆã™ã‚‹Function
create or replace function public.handle_set_host() returns trigger as $$
    begin
        update public.user set room_id = new.id where id = new.host_id;

        return new;
    end;
$$ language plpgsql security definer;

-- ãƒ«ãƒ¼ãƒ ä½œæˆæ™‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«room_idã‚’ç´ä»˜ã‘ã‚‹Trigger
drop trigger if exists on_new_room_created on public.room;
create trigger on_new_room_created
    after insert on public.room
    for each row
    execute function handle_set_host();
```

ã“ã‚Œã‚’é©ç”¨ã™ã‚‹ã¨å…ˆã»ã© Flutter å´ã®ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ç°¡æ½”ã«ãªã‚‹ã€‚

```dart
TextButton(
  onPressed: () async {
    supabase
        .from('user')
        .insert([
          {'name': 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å', 'is_host': true, 'room_id': null}
        ])
        .select()
        .single()
        .then((value) {
          // ã“ã®æ™‚ç‚¹ã§ãƒ«ãƒ¼ãƒ ä½œæˆã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®room_idã®ç´ä»˜ã‘ã¯å®Œäº†ã—ã¦ã„ã‚‹
          PushNavigator(context).push(route: RoomPage.route());
          context.showSuccessSnackBar(
            message: 'ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã—ãŸ',
          );
        })
        .catchError((e) {
          context.showErrorSnackBar(message: 'ãƒ«ãƒ¼ãƒ ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
          return null;
        });
},
```

ä¸€å¿œè£œè¶³ã§ Functions ã®æ–¹ã¯ã€ŒRemote Procedure Callã€ã¨ã—ã¦å˜ä½“ã§å‘¼ã³å‡ºã›ã‚‹ã€‚ãŒã€ä»¥ä¸‹ã®ä¾‹ã®å ´åˆã€é–¢æ•°å†…ã§ä½¿ç”¨ã•ã‚Œã„ã¦ã„ã‚‹ãƒˆãƒªã‚¬ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã«ã‚ˆã£ã¦æŒ¿å…¥ã•ã‚ŒãŸ`new`ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã€‚

```dart
final room_data = await supabase.rpc('handle_create_room');
```

> https://supabase.com/docs/reference/dart/rpc
